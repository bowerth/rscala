> source("common.R",print.eval=TRUE)
# R version 3.4.1 (2017-06-30) # becker # FALSE # TRUE
> set.seed(924234)
> 
> 
> sleep.time <- 0
> f <- function(x) { Sys.sleep(sleep.time); mean(x) }
> g <- function(x) { Sys.sleep(sleep.time); sd(x) }
> 
> 
> 
> # Native R code implementation
> doit0 <- function(x) {
+   y <- 2*x
+   c(f(y),g(y))
+ }
> 
> doit0(rnorm(10))
[1] 0.1013462 1.4964630
> 
> 
> 
> # Single callback in interpreted code.
> doit1 <- function(x) {
+   s$x <- x
+   s %@% 'R.set("y",x.map(2*_))'
+   c(s %~% 'R.evalD0("f(y)")',
+     s %~% 'R.evalD0("g(y)")')
+ }
> 
> doit1(rnorm(10))
[1] 0.6360252 2.5355099
> 
> 
> 
> # Multiple callbacks in interpreted code.
> doit2 <- function(x) {
+   s$x <- x
+   s %~% '
+     R.set("y",x.map(2*_))
+     Array(R.evalD0("f(y)"),
+           R.evalD0("g(y)"))
+   '
+ }
> 
> doit2(rnorm(10))
[1] -0.163821  1.921544
> 
> 
> 
> 
> # Multiple callbacks in compiled code.
> doit3 <- function(x=numeric()) s %!% '
+   R.set("y",x.map(2*_))
+   Array(R.evalD0("f(y)"),
+         R.evalD0("g(y)"))
+ '
> 
> doit3(rnorm(10))
[1] 0.1105979 2.3994832
> 
> 
> 
> 
> # Benchmarks
> 
> library(microbenchmark)
> 
> sleep.time <- 0
> microbenchmark(
+   doit0(rnorm(10)),
+   doit1(rnorm(10)),
+   doit2(rnorm(10)),
+   doit3(rnorm(10)),
+   times=10
+ )
Unit: microseconds
             expr         min          lq         mean       median          uq
 doit0(rnorm(10))      71.735      90.889     621.3966     137.3585     171.195
 doit1(rnorm(10)) 1007858.875 1123120.819 1224775.2856 1229747.6250 1311358.020
 doit2(rnorm(10))  451565.882  556952.696  694551.5884  636146.2830  763746.818
 doit3(rnorm(10))    2660.562    3107.107   14032.5263    3617.0725    6504.918
         max neval
    5089.899    10
 1458447.462    10
 1253469.730    10
   95623.877    10
> microbenchmark(
+   doit0(rnorm(10)),
+   #doit1(rnorm(10)),
+   #doit2(rnorm(10)),
+   doit3(rnorm(10)),
+   times=1000
+ )
Unit: microseconds
             expr      min        lq      mean   median       uq      max neval
 doit0(rnorm(10))   30.121   54.5105   70.0923   65.518   85.745   723.31  1000
 doit3(rnorm(10)) 1321.497 1620.2115 2571.7679 2350.943 2737.993 30387.16  1000
> 
> 
> sleep.time <- 0.1
> microbenchmark(
+   doit0(rnorm(10)),
+   doit1(rnorm(10)),
+   doit2(rnorm(10)),
+   doit3(rnorm(10)),
+   times=5
+ )
Unit: milliseconds
             expr      min        lq      mean    median        uq       max
 doit0(rnorm(10)) 200.3952  200.4226  200.4465  200.4374  200.4751  200.5021
 doit1(rnorm(10)) 979.6487 1122.9098 1135.6820 1154.3413 1160.6740 1260.8364
 doit2(rnorm(10)) 639.8008  671.4565  699.6603  692.6050  725.5684  768.8709
 doit3(rnorm(10)) 202.8753  203.6570  203.8353  203.7969  203.8527  204.9943
 neval
     5
     5
     5
     5
> 
> 
