> source("common.R",print.eval=TRUE)
# R version 3.4.1 (2017-06-30) # carter # TRUE # FALSE
> set.seed(924234)
> 
> 
> sleep.time <- 0
> f <- function(x) { Sys.sleep(sleep.time); mean(x) }
> g <- function(x) { Sys.sleep(sleep.time); sd(x) }
> 
> 
> 
> # Native R code implementation
> doit0 <- function(x) {
+   y <- 2*x
+   c(f(y),g(y))
+ }
> 
> doit0(rnorm(10))
[1] 0.1013462 1.4964630
> 
> 
> 
> # Single callback in interpreted code.
> doit1 <- function(x) {
+   s$x <- x
+   s %@% 'R.set("y",x.map(2*_))'
+   c(s %~% 'R.evalD0("f(y)")',
+     s %~% 'R.evalD0("g(y)")')
+ }
> 
> doit1(rnorm(10))
[1] 0.6360252 2.5355099
> 
> 
> 
> # Multiple callbacks in interpreted code.
> doit2 <- function(x) {
+   s$x <- x
+   s %~% '
+     R.set("y",x.map(2*_))
+     Array(R.evalD0("f(y)"),
+           R.evalD0("g(y)"))
+   '
+ }
> 
> doit2(rnorm(10))
[1] -0.163821  1.921544
> 
> 
> 
> 
> # Multiple callbacks in compiled code.
> doit3 <- function(x=numeric()) s %!% '
+   R.set("y",x.map(2*_))
+   Array(R.evalD0("f(y)"),
+         R.evalD0("g(y)"))
+ '
> 
> doit3(rnorm(10))
[1] 0.1105979 2.3994832
> 
> 
> 
> 
> # Benchmarks
> 
> library(microbenchmark)
> 
> sleep.time <- 0
> microbenchmark(
+   doit0(rnorm(10)),
+   doit1(rnorm(10)),
+   doit2(rnorm(10)),
+   doit3(rnorm(10)),
+   times=10
+ )
Unit: microseconds
             expr        min          lq         mean     median          uq
 doit0(rnorm(10))     72.105     119.940     576.9918     156.38     177.412
 doit1(rnorm(10)) 947223.496 1087735.457 1357313.7122 1274747.44 1527055.083
 doit2(rnorm(10)) 420799.496  542668.148  803512.9125  682379.63 1038112.037
 doit3(rnorm(10))   3908.953    5144.694   21219.4863   13716.53   21218.248
         max neval
    4516.449    10
 2270230.886    10
 1418903.344    10
   96693.497    10
> microbenchmark(
+   doit0(rnorm(10)),
+   #doit1(rnorm(10)),
+   #doit2(rnorm(10)),
+   doit3(rnorm(10)),
+   times=1000
+ )
Unit: microseconds
             expr      min       lq       mean   median       uq        max
 doit0(rnorm(10))   33.017   66.726   92.11649   79.364  101.109   2389.931
 doit3(rnorm(10)) 1762.650 3157.289 6424.46486 3511.034 5121.284 573884.157
 neval
  1000
  1000
> 
> 
> sleep.time <- 0.1
> microbenchmark(
+   doit0(rnorm(10)),
+   doit1(rnorm(10)),
+   doit2(rnorm(10)),
+   doit3(rnorm(10)),
+   times=5
+ )
Unit: milliseconds
             expr       min        lq      mean    median        uq       max
 doit0(rnorm(10))  200.4603  200.5085  204.0198  200.5134  201.5327  217.0843
 doit1(rnorm(10)) 1034.8198 1099.2897 1191.9028 1101.6844 1143.3531 1580.3668
 doit2(rnorm(10))  702.8809  719.2196  797.2611  764.4774  795.9862 1003.7416
 doit3(rnorm(10))  204.9230  208.6653  209.0310  208.7229  209.7080  213.1358
 neval
     5
     5
     5
     5
> 
> 
