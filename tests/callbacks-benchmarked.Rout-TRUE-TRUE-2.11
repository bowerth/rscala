> source("common.R",print.eval=TRUE)
# R version 3.4.1 (2017-06-30) # becker # TRUE # TRUE
> set.seed(924234)
> 
> 
> sleep.time <- 0
> f <- function(x) { Sys.sleep(sleep.time); mean(x) }
> g <- function(x) { Sys.sleep(sleep.time); sd(x) }
> 
> 
> 
> # Native R code implementation
> doit0 <- function(x) {
+   y <- 2*x
+   c(f(y),g(y))
+ }
> 
> doit0(rnorm(10))
[1] 0.1013462 1.4964630
> 
> 
> 
> # Single callback in interpreted code.
> doit1 <- function(x) {
+   s$x <- x
+   s %@% 'R.set("y",x.map(2*_))'
+   c(s %~% 'R.evalD0("f(y)")',
+     s %~% 'R.evalD0("g(y)")')
+ }
> 
> doit1(rnorm(10))
[1] 0.6360252 2.5355099
> 
> 
> 
> # Multiple callbacks in interpreted code.
> doit2 <- function(x) {
+   s$x <- x
+   s %~% '
+     R.set("y",x.map(2*_))
+     Array(R.evalD0("f(y)"),
+           R.evalD0("g(y)"))
+   '
+ }
> 
> doit2(rnorm(10))
[1] -0.163821  1.921544
> 
> 
> 
> 
> # Multiple callbacks in compiled code.
> doit3 <- function(x=numeric()) s %!% '
+   R.set("y",x.map(2*_))
+   Array(R.evalD0("f(y)"),
+         R.evalD0("g(y)"))
+ '
> 
> doit3(rnorm(10))
[1] 0.1105979 2.3994832
> 
> 
> 
> 
> # Benchmarks
> 
> library(microbenchmark)
> 
> sleep.time <- 0
> microbenchmark(
+   doit0(rnorm(10)),
+   doit1(rnorm(10)),
+   doit2(rnorm(10)),
+   doit3(rnorm(10)),
+   times=10
+ )
Unit: microseconds
             expr        min         lq         mean      median          uq
 doit0(rnorm(10))     68.369    122.102     579.2053    177.9405     193.086
 doit1(rnorm(10)) 730839.319 773144.582 1001758.7966 937604.7055 1092618.295
 doit2(rnorm(10)) 384963.986 408536.231  588075.8787 540356.0140  801292.325
 doit3(rnorm(10))   3469.068   6114.908   19414.2403   9977.1325   20079.617
         max neval
    4444.961    10
 1753725.236    10
  817131.791    10
   92853.867    10
> microbenchmark(
+   doit0(rnorm(10)),
+   #doit1(rnorm(10)),
+   #doit2(rnorm(10)),
+   doit3(rnorm(10)),
+   times=1000
+ )
Unit: microseconds
             expr      min       lq       mean   median      uq       max neval
 doit0(rnorm(10))   30.904   62.775   89.36155   75.685  108.88   2358.31  1000
 doit3(rnorm(10)) 1696.008 2771.396 5189.80405 3512.680 4148.32 486392.50  1000
> 
> 
> sleep.time <- 0.1
> microbenchmark(
+   doit0(rnorm(10)),
+   doit1(rnorm(10)),
+   doit2(rnorm(10)),
+   doit3(rnorm(10)),
+   times=5
+ )
Unit: milliseconds
             expr      min       lq     mean    median        uq       max
 doit0(rnorm(10)) 200.4450 200.4640 200.5961  200.4730  200.5360  201.0628
 doit1(rnorm(10)) 806.9508 904.4150 992.1388 1006.2146 1107.0704 1136.0432
 doit2(rnorm(10)) 521.3098 642.7487 664.4543  645.3938  754.2664  758.5529
 doit3(rnorm(10)) 204.2255 204.5163 208.2272  209.0396  209.6910  213.6635
 neval
     5
     5
     5
     5
> 
> 
